import compression from 'compression';import cors from 'cors';import express from 'express';import rateLimit from 'express-rate-limit';const apiLimiter=rateLimit({windowMs:15*60*1000,max:1000,message:{error:'Too many requests from this IP, please try again later.',retryAfter:15*60},standardHeaders:true,legacyHeaders:false,keyGenerator:req=>req.ip||req.connection.remoteAddress,skip:req=>req.path==='/api/health'||req.path.startsWith('/html/')||req.path.startsWith('/demo')});const configureCompression=app=>app.use(compression({threshold:1024}));const configureTimeout=app=>{app.use((req,res,next)=>{res.setTimeout(30000,()=>{if(!res.headersSent){res.status(408).json({error:'Request timeout',message:'Request took too long to process',timeout:30000});}});next();});};const configureExpressMiddleware=app=>{app.use(cors());app.use(express.json({limit:'1mb',strict:false,type:'application/json'}));app.use(express.urlencoded({limit:'1mb',extended:true,parameterLimit:1000}));};const configureRateLimiting=app=>app.use('/api/',apiLimiter);const configureStaticFiles=app=>{app.use(express.static('.',{maxAge:'1h',etag:true,lastModified:true,setHeaders:(res,path)=>{if(path.endsWith('.html')){res.setHeader('X-Content-Type-Options','nosniff');}}}));};const configureMemoryTracking=app=>{app.use((req,res,next)=>{const{heapUsed,heapTotal,external}=process.memoryUsage();req.memoryContext={heapUsed,heapTotal,external,timestamp:Date.now()};const originalSend=res.send;res.send=function(data){res.memoryAfter=process.memoryUsage();return originalSend.call(this,data);};next();});};const configureMiddleware=app=>{configureCompression(app);configureTimeout(app);configureExpressMiddleware(app);configureRateLimiting(app);configureStaticFiles(app);configureMemoryTracking(app);};export{configureMiddleware,configureCompression,configureTimeout,configureExpressMiddleware,configureRateLimiting,configureStaticFiles,configureMemoryTracking,apiLimiter};