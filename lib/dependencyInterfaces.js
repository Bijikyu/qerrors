'use strict'; const errorTypes = require('./errorTypes'); const createQerrorsCoreDeps = qerrorsModule => ({ qerrors: qerrorsModule, logErrorWithSeverity: qerrorsModule.logErrorWithSeverity, withErrorHandling: qerrorsModule.withErrorHandling, ErrorSeverity: errorTypes.ErrorSeverity }); let defaultQerrorsCoreDeps = null; const getDefaultQerrorsCoreDeps = () => { if (!defaultQerrorsCoreDeps) { defaultQerrorsCoreDeps = createQerrorsCoreDeps(require('./qerrors')); } return defaultQerrorsCoreDeps; }; const createDefaultErrorHandlingDeps = () => getDefaultQerrorsCoreDeps(); const qerr = async (e, context, meta = {}, deps = null) => { const resolvedDeps = deps || getDefaultQerrorsCoreDeps(); return resolvedDeps.qerrors(e, context, meta ?? {}); }; const getErrorSeverity = (deps = null) => (deps || getDefaultQerrorsCoreDeps()).ErrorSeverity; const logErrorWithSeverityDI = async ({ error, functionName, context = {}, severity, deps = null }) => { const resolvedDeps = deps || getDefaultQerrorsCoreDeps(); return resolvedDeps.logErrorWithSeverity ? await resolvedDeps.logErrorWithSeverity(error, functionName, context, severity) : await Promise.resolve(resolvedDeps.qerrors(error, functionName, { ...context, severity })); }; const withErrorHandlingDI = (deps = null) => (deps || getDefaultQerrorsCoreDeps()).withErrorHandling; const resetDefaultQerrorsCoreDeps = () => { defaultQerrorsCoreDeps = null; }; module.exports = { createQerrorsCoreDeps, getDefaultQerrorsCoreDeps, createDefaultErrorHandlingDeps, qerr, getErrorSeverity, logErrorWithSeverityDI, withErrorHandlingDI, resetDefaultQerrorsCoreDeps };