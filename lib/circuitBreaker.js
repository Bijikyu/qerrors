const CircuitBreaker=require('opossum'),qerrors=require('./qerrors');function createCircuitBreaker(operation,serviceName,options={}){if(!options||options.failureThreshold<=0)throw new Error('failureThreshold must be positive');if(options.recoveryTimeoutMs<=0)throw new Error('recoveryTimeoutMs must be positive');const opossumOptions={timeout:options.timeoutMs||10000,errorThreshold:options.failureThreshold,resetTimeout:options.recoveryTimeoutMs,rollingCountTimeout:options.monitoringPeriodMs||60000,rollingCountBuckets:10,cacheEnabled:false,enabled:true};const breaker=new CircuitBreaker(operation,opossumOptions);breaker.on('open',()=>{try{qerrors(null,'circuitBreaker.open',{operation:'circuit_breaker_state_transition',serviceName,fromState:'CLOSED_OR_HALF_OPEN',toState:'OPEN'});}catch(error){console.error('Circuit breaker open logging error:',error.message);}console.log(`[CircuitBreaker] ${serviceName}: transitioning to OPEN`);});breaker.on('halfOpen',()=>{try{qerrors(null,'circuitBreaker.halfOpen',{operation:'circuit_breaker_state_transition',serviceName,fromState:'OPEN',toState:'HALF_OPEN'});}catch(error){console.error('Circuit breaker half-open logging error:',error.message);}console.log(`[CircuitBreaker] ${serviceName}: transitioning to HALF_OPEN`);});breaker.on('close',()=>{try{qerrors(null,'circuitBreaker.close',{operation:'circuit_breaker_state_transition',serviceName,fromState:'OPEN_OR_HALF_OPEN',toState:'CLOSED'});}catch(error){console.error('Circuit breaker close logging error:',error.message);}console.log(`[CircuitBreaker] ${serviceName}: transitioning to CLOSED`);});breaker.on('failure',(result,error)=>{try{qerrors(error,'circuitBreaker.failure',{operation:'circuit_breaker_failure',serviceName,hasResult:!!result,errorMessage:error?.message});}catch(qerror){console.error('qerrors logging failed in circuit breaker failure:',qerror.message);}});return{async execute(...args){try{return await breaker.fire(...args);}catch(error){try{qerrors(error,'circuitBreaker.execute',{operation:'circuit_breaker_execute',serviceName,errorMessage:error?.message});}catch(qerror){console.error('qerrors logging failed in circuit breaker execute:',qerror.message);}throw error;}},getStats(){return breaker.stats;},isClosed(){return breaker.closed;},isOpen(){return breaker.opened;},forceOpen(){breaker.open();},forceClose(){breaker.close();}};}module.exports={createCircuitBreaker};