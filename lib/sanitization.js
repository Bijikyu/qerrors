const sanitizeMessage = (message, level = 'INFO') => { if (typeof message !== 'string') message = JSON.stringify(message); const sensitivePatterns = [ { pattern: /(\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b)/g, replacement: '[CARD-REDACTED]' }, { pattern: /(\b\d{3}[\s-]?\d{2}[\s-]?\d{4}\b)/g, replacement: '[SSN-REDACTED]' }, { pattern: /(cvv?[:=]\s*)\d{3,4}/gi, replacement: '$1[REDACTED]' }, { pattern: /(password[:=]\s*)[\w\W]+?(?=\s|$|,|\}|\])/gi, replacement: '$1[REDACTED]' }, { pattern: /(api[_-]?key[:=]\s*)[\w\W]+?(?=\s|$|,|\}|\])/gi, replacement: '$1[REDACTED]' }, { pattern: /(token[:=]\s*)[\w\W]+?(?=\s|$|,|\}|\])/gi, replacement: '$1[REDACTED]' }, { pattern: /(secret[:=]\s*)[\w\W]+?(?=\s|$|,|\}|\])/gi, replacement: '$1[REDACTED]' }, { pattern: /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g, replacement: '[EMAIL-REDACTED]' }, { pattern: /(\b(?:\+?1[-.\s]?)?\(?[0-9]{3}\)?[-.\s]?[0-9]{3}[-.\s]?[0-9]{4}\b)/g, replacement: '[PHONE-REDACTED]' } ]; let sanitized = message; sensitivePatterns.forEach(({ pattern, replacement }) => { sanitized = sanitized.replace(pattern, replacement); }); return sanitized; }; const sanitizeContext = (context, level = 'INFO') => { if (!context || typeof context !== 'object') return context; if (Array.isArray(context)) { return context.map(item => { if (typeof item === 'string') return sanitizeMessage(item, level); if (typeof item === 'object') return sanitizeContext(item, level); return item; }); } const sanitized = {}; Object.keys(context).forEach(key => { const value = context[key]; const sensitiveKeys = ['password', 'token', 'secret', 'auth', 'credential', 'apikey', 'api_key']; const isSensitiveKey = sensitiveKeys.some(sensKey => key.toLowerCase().includes(sensKey)); if (isSensitiveKey && typeof value === 'string') { sanitized[key] = '[REDACTED]'; } else if (isSensitiveKey && typeof value === 'object') { sanitized[key] = sanitizeContext(value, level); } else if (typeof value === 'string') { sanitized[key] = sanitizeMessage(value, level); } else if (typeof value === 'object') { sanitized[key] = sanitizeContext(value, level); } else { sanitized[key] = value; } }); return sanitized; }; const customPatterns = []; const addCustomSanitizationPattern = (pattern, replacement, description = '') => customPatterns.push({ pattern, replacement, description }); const clearCustomSanitizationPatterns = () => { customPatterns.length = 0; }; const sanitizeWithCustomPatterns = (message, level = 'INFO') => { let sanitized = sanitizeMessage(message, level); customPatterns.forEach(({ pattern, replacement }) => { sanitized = sanitized.replace(pattern, replacement); }); return sanitized; }; module.exports = { sanitizeMessage, sanitizeContext, addCustomSanitizationPattern, clearCustomSanitizationPatterns, sanitizeWithCustomPatterns };