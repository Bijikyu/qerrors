const config = require('./config'); const pLimit = require('p-limit').default; let queueRejectCount = 0; let adviceCleanupInterval = null; let queueMetricsInterval = null; const getQueueRejectCount = () => queueRejectCount; const logQueueMetrics = () => require('./logger').then(log => log.info(`Queue metrics: rejects=${queueRejectCount}`)); const startQueueMetrics = () => { const intervalMs = config.getInt('QERRORS_METRIC_INTERVAL_MS', 1000); !queueMetricsInterval && (queueMetricsInterval = setInterval(logQueueMetrics, intervalMs)); }; const stopQueueMetrics = () => { queueMetricsInterval && (clearInterval(queueMetricsInterval), queueMetricsInterval = null); }; const startAdviceCleanup = purgeFunction => { const ttl = config.getInt('QERRORS_CACHE_TTL', 86400) * 1000; const intervalMs = Math.max(ttl / 4, 60000); !adviceCleanupInterval && (adviceCleanupInterval = setInterval(purgeFunction, intervalMs)); }; const stopAdviceCleanup = () => { adviceCleanupInterval && (clearInterval(adviceCleanupInterval), adviceCleanupInterval = null); }; const enforceQueueLimit = (currentLength, maxLength) => currentLength >= maxLength ? (queueRejectCount++, false) : true; const createLimiter = max => pLimit(max); module.exports = { createLimiter, getQueueRejectCount, logQueueMetrics, startQueueMetrics, stopQueueMetrics, startAdviceCleanup, stopAdviceCleanup, enforceQueueLimit };