/**
 * Centralized logger configuration to reduce duplication
 * Standardizes Winston logger setup across the application
 */

import winston from 'winston';
import DailyRotateFile from 'winston-daily-rotate-file';
import { formatDateTime } from 'qgenutils';
import fs from 'fs';
import path from 'path';

/**
 * Standard log formats
 */
const logFormat = winston.format.combine(
  winston.format.timestamp(),
  winston.format.errors({ stack: true }),
  winston.format.json()
);

const consoleFormat = winston.format.combine(
  winston.format.colorize(),
  winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
  winston.format.printf(({ timestamp, level, message, ...metadata }) => {
    const metaString = Object.keys(metadata).length ? 
      ` ${JSON.stringify(metadata)}` : '';
    return `${timestamp} [${level}]: ${message}${metaString}`;
  })
);

/**
 * Create standardized Winston logger
 * @param options - Logger configuration options
 * @returns Configured Winston logger instance
 */
export const createLogger = (options: {
  level?: string;
  logDir?: string;
  enableConsole?: boolean;
  enableFile?: boolean;
} = {}) => {
  const {
    level = process.env.LOG_LEVEL || 'info',
    logDir = 'logs',
    enableConsole = true,
    enableFile = true
  } = options;

  const resolvedLogDir = path.isAbsolute(logDir) ? logDir : path.resolve(process.cwd(), logDir);

  const transports: winston.transport[] = [];

  if (enableFile) {
    try {
      fs.mkdirSync(resolvedLogDir, { recursive: true });
      transports.push(
        new DailyRotateFile({
          filename: path.join(resolvedLogDir, 'fileflows-%DATE%.log'),
          datePattern: 'YYYY-MM-DD',
          maxSize: '20m',
          maxFiles: '14d',
          format: logFormat
        })
      );
    } catch {
      // File logging is best-effort; never fail logger creation if the directory is unavailable.
    }
  }

  if (enableConsole) {
    transports.push(
      new winston.transports.Console({
        format: consoleFormat
      })
    );
  }

  return winston.createLogger({
    level,
    format: logFormat,
    transports,
    exitOnError: false
  });
};

/**
 * Default logger instance
 */
const logger = createLogger();

/**
 * Standard logging methods with context support
 */
export const loggerWithContext = {
  error: (message: string, context?: any) => logger.error(message, context),
  warn: (message: string, context?: any) => logger.warn(message, context),
  info: (message: string, context?: any) => logger.info(message, context),
  debug: (message: string, context?: any) => logger.debug(message, context)
};

export default logger;