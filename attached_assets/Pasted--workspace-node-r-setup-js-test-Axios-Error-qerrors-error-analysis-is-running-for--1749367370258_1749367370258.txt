~/workspace$ node -r ./setup.js --test
Axios Error
qerrors error analysis is running for
                        error name: "NOTOKEN",
                        error message: "no token",
                        with context: "ctx"
Missing OPENAI_TOKEN in environment variables.
qerrors error analysis is running for
                        error name: "TESTERR",
                        error message: "test error",
                        with context: "test context"
qerrors is returning advice for
                                the error name: "TESTERR",
                                with the error message: "test error",
                                with context: "test context"
TESTERR {"advice":"test advice"}
qerrors error analysis is running for
                        error name: "PARSEERR",
                        error message: "test error",
                        with context: "test context"
Problem in analyzeError function of qerrors for PARSEERR: test error
qerrors error analysis is running for
                        error name: "CACHE1",
                        error message: "cache me",
                        with context: "ctx"
qerrors is returning advice for
                                the error name: "CACHE1",
                                with the error message: "cache me",
                                with context: "ctx"
CACHE1 {"advice":"cached"}
qerrors error analysis is running for
                        error name: "CACHE2",
                        error message: "cache me",
                        with context: "ctx"
cache hit for CACHE2
qerrors error analysis is running for
                        error name: "REUSEKEY",
                        error message: "reuse error",
                        with context: "ctx"
qerrors is returning advice for
                                the error name: "REUSEKEY",
                                with the error message: "reuse error",
                                with context: "ctx"
REUSEKEY {"info":"first"}
qerrors error analysis is running for
                        error name: "REUSEKEY",
                        error message: "reuse error",
                        with context: "ctx"
cache hit for REUSEKEY
qerrors error analysis is running for
                        error name: "RETRYERR",
                        error message: "retry",
                        with context: "ctx"
✔ analyzeError handles AxiosError gracefully (4.5151ms)
✔ analyzeError returns null without token (1.98437ms)
✔ analyzeError processes JSON response from API (2.79835ms)
✔ analyzeError handles JSON parse errors (1.43321ms)
✔ analyzeError returns cached advice on repeat call (4.86536ms)
✔ analyzeError reuses error.qerrorsKey when present (1.82169ms)
qerrors is returning advice for
                                the error name: "RETRYERR",
                                with the error message: "retry",
                                with context: "ctx"
RETRYERR {"ok":true}
qerrors error analysis is running for
                        error name: "HELPER",
                        error message: "helper",
                        with context: "ctx"
qerrors is returning advice for
                                the error name: "HELPER",
                                with the error message: "helper",
                                with context: "ctx"
HELPER {"ok":true}
qerrors error analysis is running for
                        error name: "NOCACHE1",
                        error message: "nocache",
                        with context: "ctx"
qerrors is returning advice for
                                the error name: "NOCACHE1",
                                with the error message: "nocache",
                                with context: "ctx"
NOCACHE1 {"msg":1}
qerrors error analysis is running for
                        error name: "NOCACHE2",
                        error message: "nocache",
                        with context: "ctx"
qerrors is returning advice for
                                the error name: "NOCACHE2",
                                with the error message: "nocache",
                                with context: "ctx"
NOCACHE2 {"msg":2}
qerrors error analysis is running for
                        error name: "NOHASH",
                        error message: "nohash",
                        with context: "ctx"
✔ analyzeError retries failed axios calls (26.269628ms)
(node:1873) [LRU_CACHE_UNBOUNDED] UnboundedCacheWarning: TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.
(Use `node --trace-warnings ...` to show where the warning was created)
✔ analyzeError uses postWithRetry helper (1.6933ms)
✔ analyzeError bypasses cache when limit is zero (5.87516ms)
OpenAI request failed after retries
✔ analyzeError does not hash when cache limit is zero (637.736004ms)
qerrors error analysis is running for
                        error name: "CACHECLR",
                        error message: "boom",
                        with context: "ctx"
qerrors is returning advice for
                                the error name: "CACHECLR",
                                with the error message: "boom",
                                with context: "ctx"
CACHECLR {"info":"one"}
qerrors error analysis is running for
                        error name: "CACHECLR",
                        error message: "boom",
                        with context: "ctx"
cache hit for CACHECLR
qerrors error analysis is running for
                        error name: "CACHECLR",
                        error message: "boom",
                        with context: "ctx"
qerrors is returning advice for
                                the error name: "CACHECLR",
                                with the error message: "boom",
                                with context: "ctx"
CACHECLR {"info":"two"}
✔ clearAdviceCache empties cache (186.190607ms)
✔ cache limit above threshold clamps and warns (4.29891ms)
Missing required environment variables: REQUIRED_VAR
Error: Missing required environment variables: REQUIRED_VAR
    at throwIfMissingEnvVars (/home/runner/workspace/lib/envUtils.js:36:28)
    at /home/runner/workspace/test/envUtils.test.js:57:24
    at getActual (node:assert:498:5)
    at Function.throws (node:assert:644:24)
    at TestContext.<anonymous> (/home/runner/workspace/test/envUtils.test.js:56:23)
    at Test.runInAsyncScope (node:async_hooks:206:9)
    at Test.run (node:internal/test_runner/test:796:25)
    at Test.processPendingSubtests (node:internal/test_runner/test:527:18)
    at Test.postRun (node:internal/test_runner/test:889:19)
    at Test.run (node:internal/test_runner/test:835:12)
✔ getMissingEnvVars identifies missing variables (2.78777ms)
✔ getMissingEnvVars returns empty array when all present (0.25763ms)
✔ throwIfMissingEnvVars throws when variables missing (4.81609ms)
✔ throwIfMissingEnvVars returns empty array when all present (0.31106ms)
✔ warnIfMissingEnvVars returns false when variables missing (0.49882ms)
✔ warnIfMissingEnvVars returns true when all present (0.227009ms)
✔ warnIfMissingEnvVars uses custom message (0.27282ms)
✔ index exports qerrors and logger (2.295169ms)
✔ warn when limits exceed safe threshold (193.397576ms)
✔ limits below custom threshold do not warn (2.40893ms)
qerrors is running for error message: "boom",
                        with context: "spyCtx",
                        assigning it the unique error name: "ERROR:Error_bae13a15-e6b0-4b4d-97cd-78849610e5ba"
qerrors ran
qerrors error analysis is running for
                        error name: "ERROR:Error_bae13a15-e6b0-4b4d-97cd-78849610e5ba",
                        error message: "boom",
                        with context: "spyCtx"
qerrors is returning advice for
                                the error name: "ERROR:Error_bae13a15-e6b0-4b4d-97cd-78849610e5ba",
                                with the error message: "boom",
                                with context: "spyCtx"
ERROR:Error_bae13a15-e6b0-4b4d-97cd-78849610e5ba {"ok":true}
✔ qerrors integration logs error and analyzes context (17.814589ms)
✔ logger exposes standard logging methods (20.541519ms)
✔ logger uses daily rotate when QERRORS_LOG_MAX_DAYS set (5.75778ms)
✔ file transports active when mkdirSync succeeds (2.40048ms)
✔ logger continues with console transport when mkdirSync fails (2.98392ms)
✔ logger warns when max days zero with file logs (10.227879ms)
✔ axiosInstance honors QERRORS_MAX_SOCKETS (157.494688ms)
✔ axiosInstance uses default max sockets when env missing (2.69905ms)
✔ axiosInstance uses default max sockets with invalid env (2.99513ms)
✔ max sockets above threshold clamps and warns (21.620719ms)
✔ postWithRetry adds jitter to wait time (1.93265ms)
✔ postWithRetry uses defaults with invalid env (0.43331ms)
✔ postWithRetry enforces backoff cap (0.35059ms)
✔ postWithRetry uses Retry-After header for rate limit (0.35926ms)
✔ postWithRetry doubles delay when rate limit header missing (0.37255ms)
qerrors is running for error message: "boom",
                        with context: "ctx",
                        assigning it the unique error name: "ERROR:Error_f4e53a12-370a-4840-b515-ca25e24aeea6"
qerrors ran
qerrors error analysis is running for
                        error name: "ERROR:Error_f4e53a12-370a-4840-b515-ca25e24aeea6",
                        error message: "boom",
                        with context: "ctx"
Missing OPENAI_TOKEN in environment variables.
qerrors is running for error message: "boom",
                        with context: "ctx",
                        assigning it the unique error name: "ERROR:Error_37b21341-2638-4ead-933c-96839b39ce87"
qerrors ran
qerrors error analysis is running for
                        error name: "ERROR:Error_37b21341-2638-4ead-933c-96839b39ce87",
                        error message: "boom",
                        with context: "ctx"
✔ qerrors logs and responds with json then calls next (26.635338ms)
qerrors is running for error message: "<script>boom</script>",
                        with context: "ctx",
                        assigning it the unique error name: "ERROR:Error_abcda036-b07b-4688-b408-ae1ff98fccff"
qerrors ran
qerrors error analysis is running for
                        error name: "ERROR:Error_abcda036-b07b-4688-b408-ae1ff98fccff",
                        error message: "<script>boom</script>",
                        with context: "ctx"
✔ qerrors sends html when accept header requests it (3.00446ms)
qerrors is running for error message: "not found",
                        with context: "ctx",
                        assigning it the unique error name: "ERROR:Error_ba00fa48-db49-4872-9c46-b40b81985df6"
qerrors ran
qerrors error analysis is running for
                        error name: "ERROR:Error_ba00fa48-db49-4872-9c46-b40b81985df6",
                        error message: "not found",
                        with context: "ctx"
✔ qerrors escapes html content (1.94654ms)
qerrors is running for error message: "not found",
                        with context: "ctx",
                        assigning it the unique error name: "ERROR:Error_04783aed-969f-4008-a40a-d170ee96bf03"
qerrors ran
qerrors error analysis is running for
                        error name: "ERROR:Error_04783aed-969f-4008-a40a-d170ee96bf03",
                        error message: "not found",
                        with context: "ctx"
✔ qerrors honors error.statusCode in json (1.67966ms)
qerrors is running for error message: "boom",
                        with context: "ctx",
                        assigning it the unique error name: "ERROR:Error_094b83e9-5fed-42f1-ba55-820fc452bb96"
qerrors ran
qerrors error analysis is running for
                        error name: "ERROR:Error_094b83e9-5fed-42f1-ba55-820fc452bb96",
                        error message: "boom",
                        with context: "ctx"
✔ qerrors honors error.statusCode in html (1.29097ms)
qerrors is running for error message: "boom",
                        with context: "unknown context",
                        assigning it the unique error name: "ERROR:Error_cbd5b3ab-a4e8-48cf-94a0-34550448a6fd"
qerrors ran
qerrors error analysis is running for
                        error name: "ERROR:Error_cbd5b3ab-a4e8-48cf-94a0-34550448a6fd",
                        error message: "boom",
                        with context: "unknown context"
✔ qerrors does nothing when headers already sent (2.56723ms)
qerrors is running for error message: "boom",
                        with context: "ctx",
                        assigning it the unique error name: "ERROR:Error_b4a459c9-86f9-4777-86ab-32e90554623c"
qerrors ran
qerrors error analysis is running for
                        error name: "ERROR:Error_b4a459c9-86f9-4777-86ab-32e90554623c",
                        error message: "boom",
                        with context: "ctx"
✔ qerrors handles absence of req res and next (2.91429ms)
✔ qerrors calls next without res (2.73844ms)
✔ qerrors exits if no error provided (1.75741ms)
qerrors is running for error message: "one",
                        with context: "unknown context",
                        assigning it the unique error name: "ERROR:Error_cbdb7413-313a-4ec2-80f6-bb33ea2bdeda"
qerrors is running for error message: "two",
                        with context: "unknown context",
                        assigning it the unique error name: "ERROR:Error_b7f56955-20f2-42c2-883f-8f2c2fc4ba66"
qerrors is running for error message: "three",
                        with context: "unknown context",
                        assigning it the unique error name: "ERROR:Error_c4952007-3091-4425-b0ee-cab771e2c69a"
qerrors ran
qerrors ran
qerrors ran
qerrors error analysis is running for
                        error name: "ERROR:Error_cbdb7413-313a-4ec2-80f6-bb33ea2bdeda",
                        error message: "one",
                        with context: "unknown context"
Missing OPENAI_TOKEN in environment variables.
qerrors is running for error message: "one",
                        with context: "unknown context",
                        assigning it the unique error name: "ERROR:Error_d5e89bd3-1a80-4be3-9d63-716f56a125b8"
qerrors is running for error message: "two",
                        with context: "unknown context",
                        assigning it the unique error name: "ERROR:Error_0a3cf42e-3ae0-4716-be8d-9aaea41fee7b"
qerrors is running for error message: "three",
                        with context: "unknown context",
                        assigning it the unique error name: "ERROR:Error_ccaba7b0-4c0b-4f59-9a80-a66cd0b46800"
qerrors ran
qerrors ran
qerrors ran
qerrors error analysis is running for
                        error name: "ERROR:Error_d5e89bd3-1a80-4be3-9d63-716f56a125b8",
                        error message: "one",
                        with context: "unknown context"
✔ scheduleAnalysis rejects when queue exceeds limit (193.641056ms)
Missing OPENAI_TOKEN in environment variables.
qerrors is running for error message: "one",
                        with context: "unknown context",
                        assigning it the unique error name: "ERROR:Error_4cb44dad-9bad-4752-b5aa-92336d0ddc9d"
qerrors is running for error message: "two",
                        with context: "unknown context",
                        assigning it the unique error name: "ERROR:Error_40e09481-b46d-4db8-8c27-8f877e24e702"
qerrors ran
qerrors ran
qerrors error analysis is running for
                        error name: "ERROR:Error_4cb44dad-9bad-4752-b5aa-92336d0ddc9d",
                        error message: "one",
                        with context: "unknown context"
✔ queue reject count increments when queue exceeds limit (32.561938ms)
qerrors is returning advice for
                                the error name: "ERROR:Error_4cb44dad-9bad-4752-b5aa-92336d0ddc9d",
                                with the error message: "one",
                                with context: "unknown context"
ERROR:Error_4cb44dad-9bad-4752-b5aa-92336d0ddc9d {}
qerrors error analysis is running for
                        error name: "ERROR:Error_40e09481-b46d-4db8-8c27-8f877e24e702",
                        error message: "two",
                        with context: "unknown context"
qerrors is returning advice for
                                the error name: "ERROR:Error_40e09481-b46d-4db8-8c27-8f877e24e702",
                                with the error message: "two",
                                with context: "unknown context"
ERROR:Error_40e09481-b46d-4db8-8c27-8f877e24e702 {}
qerrors is running for error message: "one",
                        with context: "unknown context",
                        assigning it the unique error name: "ERROR:Error_78f0be70-bfdb-49be-b1c9-d5afb30f2cb5"
qerrors is running for error message: "two",
                        with context: "unknown context",
                        assigning it the unique error name: "ERROR:Error_36bf94ba-0848-43f5-b996-68db4b99e0f8"
qerrors is running for error message: "three",
                        with context: "unknown context",
                        assigning it the unique error name: "ERROR:Error_f9bd1569-5bca-44bd-a1d5-ec2697cc375d"
qerrors is running for error message: "four",
                        with context: "unknown context",
                        assigning it the unique error name: "ERROR:Error_80735358-cc3c-44de-a4ae-a4b3acfd33ef"
qerrors is running for error message: "five",
                        with context: "unknown context",
                        assigning it the unique error name: "ERROR:Error_e575f520-80e7-490b-9ae2-ff685b4032a9"
qerrors ran
qerrors ran
qerrors ran
qerrors ran
qerrors ran
qerrors error analysis is running for
                        error name: "ERROR:Error_78f0be70-bfdb-49be-b1c9-d5afb30f2cb5",
                        error message: "one",
                        with context: "unknown context"
Missing OPENAI_TOKEN in environment variables.
✔ getQueueLength reflects queued analyses (48.715706ms)
✔ scheduleAnalysis uses defaults on invalid env (0.96834ms)
✔ queue never exceeds limit under high concurrency (53.376287ms)
✔ logger uses QERRORS_SERVICE_NAME env var (18.515558ms)
✔ logger defaults QERRORS_SERVICE_NAME when unset (10.53314ms)
✔ axiosInstance honors QERRORS_TIMEOUT (121.257801ms)
✔ axiosInstance uses default timeout when env missing (1.5498ms)
✔ axiosInstance uses default timeout with invalid env (1.47881ms)
✔ logger adds Console transport when verbose true (14.418739ms)
✔ logger excludes Console transport when verbose false (11.032789ms)
ℹ tests 58
ℹ suites 0
ℹ pass 58
ℹ fail 0
ℹ cancelled 0
ℹ skipped 0
ℹ todo 0
ℹ duration_ms 958.429143